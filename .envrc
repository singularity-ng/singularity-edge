#!/usr/bin/env bash
# Singularity Edge - Automatic Nix Flake Development Environment
# Make sure you have direnv installed and hooked into your shell
# Run: direnv allow

# Use nix-direnv for better flake support and caching
if ! has nix_direnv_version || ! nix_direnv_version 3.0.4; then
  source_url "https://raw.githubusercontent.com/nix-community/nix-direnv/3.0.4/direnvrc" "sha256-DzlYZ33mWF/Gs8DDeyjr8mnVmQGx7ASYqA5WlxwvBG4="
fi

# Watch for changes to flake files and reload automatically
watch_file flake.nix
watch_file flake.lock

# Watch for changes to Mix files (Elixir)
watch_file mix.exs
watch_file mix.lock

# Configure Nix settings directly in direnv to avoid approval prompts
# These settings are automatically trusted since they're in .envrc
# Priority: mikkihugo (Cachix) > cache.nixos.org (NixOS official)
# Cachix speeds up builds by using pre-built packages
export NIX_CONFIG="substituters = https://mikkihugo.cachix.org https://cache.nixos.org"

# Enable flake support
use flake

# Ensure nix-provided tools take precedence over mise
# Remove mise shims from PATH and prepend nix paths
PATH_WITHOUT_MISE=$(echo "$PATH" | tr ':' '\n' | grep -v '/mise/shims' | tr '\n' ':' | sed 's/:$//')
export PATH="$PATH_WITHOUT_MISE"

# Load local environment and secrets (auto-generate if missing)
if [ ! -f .envrc.local ]; then
  if [ -f scripts/setup-secrets.sh ]; then
    echo "üîê Generating development secrets..."
    bash scripts/setup-secrets.sh
  fi
fi

# Load secrets from .envrc.local
if [ -f .envrc.local ]; then
  source_env .envrc.local
fi
